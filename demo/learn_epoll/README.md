### æ ¸å¿ƒä»»åŠ¡ï¼šç¼–å†™ä¸€ä¸ªå•çº¿ç¨‹ TCP Echo Server

**åŠŸèƒ½æè¿°ï¼š** æœåŠ¡å™¨ç›‘å¬ç«¯å£ï¼ˆå¦‚ 8888ï¼‰ï¼Œæ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¿æ¥ï¼ˆä½¿ç”¨ `nc` æˆ– `telnet` æµ‹è¯•ï¼‰ã€‚å®¢æˆ·ç«¯å‘ä»€ä¹ˆï¼ŒæœåŠ¡å™¨å°±å›ä»€ä¹ˆã€‚

---

## å­¦ä¹ è·¯å¾„

```
Demo 0: é˜»å¡ç‰ˆ (ä½“éªŒå•çº¿ç¨‹é˜»å¡ I/O çš„ç—›è‹¦)
  â†“
Demo 1: select (ç†è§£ä½å›¾ + å…¨é‡éå†)
  â†“
Demo 2: poll (ç†è§£ç»“æ„ä½“æ•°ç»„ + å…¨é‡éå†)
  â†“  
Demo 3: epoll LT (ç†è§£äº‹ä»¶é©±åŠ¨ + O(1) æ•ˆç‡)
  â†“
Demo 4: epoll ET (æŒæ¡è¾¹ç¼˜è§¦å‘ + éé˜»å¡ I/O)
```

---

#### Demo 0: åŸºç¡€ â€”â€” é˜»å¡ç‰ˆæœ¬ï¼ˆå•å®¢æˆ·ç«¯ï¼‰

**å­¦ä¹ ç›®æ ‡ï¼š** ä½“éªŒ"å•çº¿ç¨‹é˜»å¡ I/O"çš„é—®é¢˜ â€”â€” ä¸€æ¬¡åªèƒ½æœåŠ¡ä¸€ä¸ªå®¢æˆ·ç«¯ã€‚

**ä½ éœ€è¦åšçš„äº‹ï¼š**
1. åˆ›å»ºç›‘å¬ socketï¼Œç»‘å®š 8888 ç«¯å£ã€‚
2. åœ¨ `while(1)` å¾ªç¯é‡Œ `accept` æ–°è¿æ¥ã€‚
3. `read` æ•°æ®ï¼Œç„¶å `write` å›æ˜¾ã€‚

> **ä½“éªŒç—›ç‚¹ï¼š** å½“ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥åï¼Œ`read` ä¼šé˜»å¡ä½ï¼Œå…¶ä»–å®¢æˆ·ç«¯çš„ `accept` æ ¹æœ¬è¿›ä¸æ¥ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦ I/O å¤šè·¯å¤ç”¨ã€‚

---

#### Demo 1: å…¥é—¨ â€”â€” ä½¿ç”¨ `select` å®ç°

**å­¦ä¹ ç›®æ ‡ï¼š** ç†è§£â€œä½å›¾ï¼ˆBitmapï¼‰â€å’Œâ€œè½®è¯¢â€çš„æ¦‚å¿µã€‚ **ä½ éœ€è¦åšçš„äº‹ï¼š**

1.  åˆ›å»ºä¸€ä¸ª `fd_set` é›†åˆï¼ˆ`rfds`ï¼‰ã€‚
    
2.  æŠŠç›‘å¬ socket (`listen_fd`) æ”¾è¿›å»ã€‚
    
3.  åœ¨ä¸€ä¸ª `while(1)` å¾ªç¯é‡Œè°ƒç”¨ `select()`ã€‚
    
4.  **å…³é”®ç‚¹ï¼š**
    
    -   æ¯æ¬¡è°ƒç”¨ `select` å‰ï¼Œéƒ½éœ€è¦**é‡ç½®** `fd_set`ï¼ˆå› ä¸º select ä¼šä¿®æ”¹å®ƒï¼Œè¿™æ˜¯ä¸ªè‘—åçš„å‘ï¼‰ã€‚
        
    -   `select` è¿”å›åï¼Œä½ éœ€è¦å†™ä¸€ä¸ª `for` å¾ªç¯ï¼Œä» 0 éå†åˆ° `max_fd`ï¼Œç”¨ `FD_ISSET` æŒ¨ä¸ªæ£€æŸ¥æ˜¯è°æœ‰æ•°æ®ã€‚
        
    -   å¦‚æœæ˜¯ `listen_fd` åŠ¨äº†ï¼Œè¯´æ˜æœ‰æ–°è¿æ¥ (`accept`)ï¼›å¦‚æœæ˜¯å…¶ä»– fd åŠ¨äº†ï¼Œè¯´æ˜æœ‰æ•°æ®å‘æ¥ (`read` & `write`)ã€‚
        

> **ä½“éªŒç—›ç‚¹ï¼š** ä½ ä¼šå‘ç°ä»£ç é‡Œå¿…é¡»ç»´æŠ¤ä¸€ä¸ª `max_fd` å˜é‡ï¼Œè€Œä¸”æ¯æ¬¡éƒ½è¦éå†æ‰€æœ‰ fdï¼Œå“ªæ€•åªæœ‰ä¸€ä¸ª fd æ´»è·ƒã€‚

#### Demo 2: è¿‡æ¸¡ â€”â€” ä½¿ç”¨ `poll` å®ç°

**å­¦ä¹ ç›®æ ‡ï¼š** ç†è§£â€œç»“æ„ä½“æ•°ç»„â€å¦‚ä½•å–ä»£â€œä½å›¾â€ã€‚ **ä½ éœ€è¦åšçš„äº‹ï¼š**

1.  æŠŠ Demo 1 é‡Œçš„ `fd_set` æ¢æˆä¸€ä¸ª `struct pollfd` æ•°ç»„ï¼ˆä¾‹å¦‚ `struct pollfd fds[1024]`ï¼‰ã€‚
    
2.  æŠŠ `select()` æ¢æˆ `poll()`ã€‚
    
3.  **å…³é”®ç‚¹ï¼š**
    
    -   ä¸éœ€è¦åƒ select é‚£æ ·æ¯æ¬¡é‡ç½®é›†åˆäº†ï¼ˆå› ä¸º `poll` æŠŠâ€œå…³å¿ƒçš„äº‹ä»¶â€å’Œâ€œå‘ç”Ÿçš„äº‹ä»¶â€åˆ†å¼€äº†ï¼‰ã€‚
        
    -   ä½†æ˜¯ï¼`poll` è¿”å›åï¼Œä½ ä¾ç„¶éœ€è¦å†™ä¸€ä¸ª `for` å¾ªç¯éå†æ•´ä¸ª `fds` æ•°ç»„ï¼Œæ£€æŸ¥ `revents` å­—æ®µã€‚
        

> **ä½“éªŒç—›ç‚¹ï¼š** è™½ç„¶æ²¡æœ‰äº† 1024 ä¸ªè¿æ¥çš„é™åˆ¶ï¼Œä½†ä½ å‘ç°â€œéå†æ•´ä¸ªæ•°ç»„â€è¿™ä¸ªåŠ¨ä½œä¾ç„¶æ²¡å˜ã€‚

#### Demo 3: ç°ä»£ â€”â€” ä½¿ç”¨ `epoll` (LTæ¨¡å¼) å®ç°

**å­¦ä¹ ç›®æ ‡ï¼š** ç†è§£â€œäº‹ä»¶é©±åŠ¨â€å’Œâ€œO(1) æ•ˆç‡â€ã€‚ **ä½ éœ€è¦åšçš„äº‹ï¼š**

1.  ä½¿ç”¨ `epoll_create` åˆ›å»ºä¸€ä¸ªå¥æŸ„ã€‚
    
2.  ä½¿ç”¨ `epoll_ctl` æŠŠ `listen_fd` æ·»åŠ è¿›å» (`EPOLL_CTL_ADD`)ã€‚
    
3.  åœ¨ `while` å¾ªç¯é‡Œè°ƒç”¨ `epoll_wait`ã€‚
    
4.  **å…³é”®ç‚¹ï¼ˆæœ€çˆ½çš„åœ°æ–¹ï¼‰ï¼š**
    
    -   `epoll_wait` ä¼šè¿”å›ä¸€ä¸ªæ•´æ•° `n`ï¼Œè¡¨ç¤ºæœ‰ `n` ä¸ªäº‹ä»¶å‘ç”Ÿäº†ã€‚
        
    -   ä½ åªéœ€è¦éå† `events` æ•°ç»„çš„**å‰ n ä¸ªå…ƒç´ **ã€‚è¿™é‡Œé¢æ¯ä¸€ä¸ªå…¨æ˜¯â€œå¹²è´§â€ï¼ˆæ´»è·ƒçš„è¿æ¥ï¼‰ï¼Œä¸éœ€è¦åƒ select/poll é‚£æ ·éå†æ— æ•ˆçš„ç©ºè¿æ¥ã€‚
        

___

### è¿›é˜¶ä»»åŠ¡ (å¯é€‰ï¼Œä½†æ¨è)

#### Demo 4: è´¨å˜ â€”â€” `epoll` (ETæ¨¡å¼) + éé˜»å¡ I/O

**åœºæ™¯ï¼š** æ¨¡æ‹Ÿæ•°æ®åŒ…æˆªæ–­ï¼ˆæ¯”å¦‚ç¼“å†²åŒºåªæœ‰ 1 å­—èŠ‚ï¼Œå¼ºè¿«ä½ å¤šæ¬¡è¯»å–ï¼‰ã€‚ **ä½ éœ€è¦åšçš„äº‹ï¼š**

1.  åœ¨ Demo 3 çš„åŸºç¡€ä¸Šï¼ŒæŠŠäº‹ä»¶æ³¨å†Œæ”¹ä¸º `EPOLLET` (Edge Triggered)ã€‚
    
2.  æŠŠ socket è®¾ç½®ä¸ºéé˜»å¡ (`O_NONBLOCK`)ã€‚
    
3.  **å…³é”®ç‚¹ï¼š**
    
    -   å½“ `epoll_wait` é€šçŸ¥ä½ å¯è¯»æ—¶ï¼Œä½ å¿…é¡»ç”¨ä¸€ä¸ª `while` å¾ªç¯ä¸€ç›´ `read`ï¼Œç›´åˆ° `read` è¿”å› -1 å¹¶ä¸” `errno == EAGAIN`ã€‚
        
    -   å¦‚æœä¸è¯»å®Œï¼Œä¸‹æ¬¡ `epoll_wait` å°±ä¼šâ€œè£…æ­»â€ï¼Œä¸å†é€šçŸ¥ä½ ï¼Œå¯¼è‡´å®¢æˆ·ç«¯å¡æ­»ã€‚
        

---

### å¦‚ä½•æµ‹è¯•ä½ çš„ Demoï¼Ÿ

#### æ–¹æ³• 1: æ‰‹åŠ¨æµ‹è¯•
1. **å¯åŠ¨æœåŠ¡å™¨ï¼š** `./demo0_blocking` (æˆ– demo1_select, demo2_poll ç­‰)
2. **å¼€å¯å¤šä¸ªç»ˆç«¯ï¼Œæ¨¡æ‹Ÿå¤šä¸ªç”¨æˆ·ï¼š**
   ```bash
   # ç»ˆç«¯ 1
   nc 127.0.0.1 8888
   
   # ç»ˆç«¯ 2
   nc 127.0.0.1 8888
   ```
3. åœ¨ nc ä¸­è¾“å…¥æ–‡å­—ï¼Œè§‚å¯ŸæœåŠ¡å™¨å›æ˜¾è¡Œä¸ºã€‚

#### æ–¹æ³• 2: è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
```bash
#!/bin/bash
# test_concurrent.sh
for i in {1..10}; do
    echo "Client $i: Hello" | nc 127.0.0.1 8888 &
done
wait
```

#### æ–¹æ³• 3: æ€§èƒ½å‹æµ‹ï¼ˆå¯¹æ¯”ä¸åŒå®ç°ï¼‰
```bash
# å®‰è£… apache bench
# macOS: brew install httpd (åŒ…å« ab å·¥å…·ï¼Œä½†éœ€è¦è‡ªå·±å†™ç®€å•çš„ HTTP å“åº”)
# æˆ–è€…ç”¨ wrk/vegeta ç­‰å·¥å…·

# ç®€å•å¹¶å‘æµ‹è¯•
seq 1 100 | xargs -P 100 -I {} sh -c 'echo "test" | nc 127.0.0.1 8888'
```

---

### ç¼–è¯‘å’Œè¿è¡Œ

```bash
# ç¼–è¯‘æ‰€æœ‰ Demo
make

# æˆ–è€…å•ç‹¬ç¼–è¯‘
gcc -o demo0_blocking demo0_blocking.c
gcc -o demo1_select demo1_select.c
gcc -o demo2_poll demo2_poll.c
gcc -o demo3_epoll_lt demo3_epoll_lt.c
gcc -o demo4_epoll_et demo4_epoll_et.c

# è¿è¡Œ
./demo1_select
```

---

### æ€§èƒ½æµ‹è¯•è„šæœ¬

#### 1. å¿«é€Ÿå¯¹æ¯” (æ¨è)
```bash
./compare.sh
```
è¾“å‡ºç¤ºä¾‹ï¼š
```
Select:              1234 ms  (61.70 ms/req)
Poll:                1189 ms  (59.45 ms/req)
Epoll LT:             987 ms  (49.35 ms/req)
Epoll ET:             965 ms  (48.25 ms/req)
```

#### 2. å®Œæ•´æ€§èƒ½æµ‹è¯•
```bash
./benchmark.sh
```
æµ‹è¯•ä¸åŒå¹¶å‘æ•°ä¸‹çš„ååé‡å’Œå“åº”æ—¶é—´ã€‚

#### 3. å‹åŠ›æµ‹è¯•
```bash
./stress_test.sh demo1_select
./stress_test.sh demo3_epoll_lt
```
100 å¹¶å‘è¿æ¥ï¼Œæ¯ä¸ªå‘é€ 10 æ¡æ¶ˆæ¯ï¼Œå¯¹æ¯”æé™æ€§èƒ½ã€‚

---

### å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] Demo 0: èƒ½å¦ä½“ä¼šåˆ°é˜»å¡ I/O çš„"å¡é¡¿"ï¼Ÿ
- [ ] Demo 1: æ˜¯å¦ç†è§£ `FD_SET`/`FD_ISSET` çš„ä½å›¾æ“ä½œï¼Ÿ
- [ ] Demo 1: æ˜¯å¦è®°å¾—æ¯æ¬¡ `select` å‰è¦é‡ç½® `fd_set`ï¼Ÿ
- [ ] Demo 2: æ˜¯å¦æ„Ÿå—åˆ°ä¸éœ€è¦ç»´æŠ¤ `max_fd` çš„ä¾¿åˆ©ï¼Ÿ
- [ ] Demo 3: æ˜¯å¦æƒŠå¹äº `epoll_wait` åªè¿”å›æ´»è·ƒè¿æ¥çš„é«˜æ•ˆï¼Ÿ
- [ ] Demo 4: æ˜¯å¦è¸©è¿‡"ET æ¨¡å¼ä¸å¾ªç¯è¯»å¯¼è‡´å¡æ­»"çš„å‘ï¼Ÿ

---

### æ ¸å¿ƒçŸ¥è¯†ç‚¹å¯¹æ¯”

| ç‰¹æ€§ | select | poll | epoll |
|------|--------|------|-------|
| æ•°æ®ç»“æ„ | ä½å›¾ (fd_set) | æ•°ç»„ (pollfd) | çº¢é»‘æ ‘ + å°±ç»ªé“¾è¡¨ |
| æœ€å¤§è¿æ¥æ•° | 1024 (FD_SETSIZE) | æ— é™åˆ¶ | æ— é™åˆ¶ |
| æ—¶é—´å¤æ‚åº¦ | O(n) | O(n) | O(1) |
| å†…æ ¸æ‹·è´ | æ¯æ¬¡éƒ½æ‹·è´ | æ¯æ¬¡éƒ½æ‹·è´ | åªåœ¨ add/del æ—¶ |
| è§¦å‘æ¨¡å¼ | LT | LT | LT/ET |
| è·¨å¹³å° | âœ… | âœ… | âŒ (Linux only) |

---

## æ€§èƒ½æµ‹è¯•

å®Œæˆæ‰€æœ‰demoåï¼Œå¯ä»¥ä½¿ç”¨æä¾›çš„æµ‹è¯•è„šæœ¬è¿›è¡Œæ€§èƒ½å¯¹æ¯”ï¼š

### ä¸€é”®è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
./run_all_tests.sh
```

è¿™ä¸ªè„šæœ¬ä¼šè‡ªåŠ¨æ‰§è¡Œï¼š
1. âœ… ç¼–è¯‘æ£€æŸ¥
2. ğŸ§ª å¿«é€ŸåŠŸèƒ½éªŒè¯
3. ğŸ“Š å®Œæ•´æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
4. ğŸ’ª å‹åŠ›æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
5. ğŸ“ˆ ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨

### å•ç‹¬è¿è¡Œå„é¡¹æµ‹è¯•

#### 1. å¿«é€ŸåŠŸèƒ½æµ‹è¯•ï¼ˆéªŒè¯æ­£ç¡®æ€§ï¼‰
```bash
./quick_test.sh
```
- æµ‹è¯•å•è¿æ¥å›æ˜¾
- æµ‹è¯•å¹¶å‘è¿æ¥
- æµ‹è¯•å¤§æ•°æ®åŒ…ä¼ è¾“

#### 2. æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆå®Œæ•´å¯¹æ¯”ï¼‰
```bash
./benchmark.sh
```
æµ‹è¯•ç»´åº¦ï¼š
- **ååé‡**: å•ä½æ—¶é—´å¤„ç†çš„è¯·æ±‚æ•°ï¼ˆreq/sï¼‰
- **å»¶è¿Ÿ**: è¯·æ±‚å¾€è¿”æ—¶é—´ï¼ˆmsï¼‰- å¹³å‡/P50/P99
- **CPUä½¿ç”¨ç‡**: ä¸åŒå¹¶å‘ä¸‹çš„CPUæ¶ˆè€—
- **æœ€å¤§å¹¶å‘**: èƒ½åŒæ—¶å¤„ç†çš„è¿æ¥æ•°ä¸Šé™

æµ‹è¯•åœºæ™¯ï¼š1ã€10ã€50ã€100ã€200ã€500ã€1000å¹¶å‘

#### 3. å‹åŠ›æµ‹è¯•ï¼ˆæé™åœºæ™¯ï¼‰
```bash
./stress_test.sh demo3_epoll_lt  # æµ‹è¯•æŒ‡å®šå®ç°
```
æµ‹è¯•åœºæ™¯ï¼š
- ğŸ”¥ å¿«é€Ÿå»ºç«‹/æ–­å¼€1000ä¸ªè¿æ¥
- â° 100ä¸ªé•¿è¿æ¥ä¿æŒ30ç§’
- ğŸ“¦ 10000ä¸ªå°æ•°æ®åŒ…ä¼ è¾“
- ğŸš€ å¤§æ•°æ®åŒ…ä¼ è¾“ï¼ˆ1KB ~ 1MBï¼‰
- ğŸŒªï¸ æ··åˆè´Ÿè½½ï¼ˆé•¿çŸ­è¿æ¥ + éšæœºæ•°æ®ï¼‰

#### 4. ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨
```bash
# éœ€è¦å…ˆå®‰è£…ä¾èµ–
pip3 install matplotlib numpy

# ç”Ÿæˆå›¾è¡¨
./visualize.py
```
ç”Ÿæˆçš„å›¾è¡¨ï¼š
- `throughput.png` - ååé‡å¯¹æ¯”æ›²çº¿
- `latency.png` - å»¶è¿Ÿå¯¹æ¯”æ›²çº¿
- `cpu.png` - CPUä½¿ç”¨ç‡å¯¹æ¯”
- `maxconn.png` - æœ€å¤§è¿æ¥æ•°æŸ±çŠ¶å›¾
- `comprehensive.png` - ç»¼åˆæ€§èƒ½é›·è¾¾å›¾

### æŸ¥çœ‹æµ‹è¯•ç»“æœ

```bash
# æŸ¥çœ‹æ–‡å­—æŠ¥å‘Š
cat benchmark_results/benchmark_report.md

# æŸ¥çœ‹å›¾è¡¨ï¼ˆmacOSï¼‰
open benchmark_results/charts/

# æŸ¥çœ‹åŸå§‹æ•°æ®
ls -lh benchmark_results/
```

### é¢„æœŸç»“æœ

åŸºäºç†è®ºåˆ†æï¼Œæ€§èƒ½æ’ååº”è¯¥æ˜¯ï¼š

**ååé‡**: epoll_et > epoll_lt > poll > select > blocking  
**å»¶è¿Ÿ**: epoll_et â‰ˆ epoll_lt < poll < select << blocking  
**CPUæ•ˆç‡**: epollç³»åˆ— >> poll > select >> blocking  
**æœ€å¤§è¿æ¥**: epollç³»åˆ— â‰ˆ poll >> select(1024ä¸Šé™) >> blocking(1ä¸ª)

### æµ‹è¯•ç¯å¢ƒå»ºè®®

- âœ… **Linux**: å®Œæ•´æµ‹è¯•æ‰€æœ‰å®ç°ï¼ˆåŒ…æ‹¬epollï¼‰
- âš ï¸ **macOS**: å¯ä»¥æµ‹è¯•blocking/select/pollï¼ˆepollåœ¨macOSä¸å¯ç”¨ï¼‰
- âŒ **Windows**: ä¸æ”¯æŒï¼Œå»ºè®®ä½¿ç”¨Dockeræˆ–WSL2

### Dockeræµ‹è¯•ï¼ˆæ¨èï¼‰

å¦‚æœåœ¨macOSä¸Šæƒ³æµ‹è¯•epollï¼š

```bash
# è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
cd ../../  # è¿”å›åˆ° TinyTCP-Over-TUN æ ¹ç›®å½•

# ä½¿ç”¨Dockerç¯å¢ƒ
docker-compose run --rm dev /bin/bash

# åœ¨å®¹å™¨å†…
cd demo/learn_epoll
make
./run_all_tests.sh
```